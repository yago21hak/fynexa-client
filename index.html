<!DOCTYPE html>
<html lang="hy">
<head>
    <style>
        /* --- Ավելացված Loading Անիմացիա --- */
        .typing {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            width: fit-content;
            margin-bottom: 10px;
        }
        .typing span {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing span:nth-child(1) { animation-delay: -0.32s; }
        .typing span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <script>
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }

        let isAiLoading = false; // Rate limiting-ի և loading-ի համար

        async function sendAiMessage() {
            const input = document.getElementById('user-input');
            const container = document.getElementById('chat-messages');
            const text = input.value.trim();
            
            if(!text || isAiLoading) return; // Արգելում ենք նոր հարցումը, եթե արդեն բեռնվում է

            // 1. Ավելացնում ենք օգտատիրոջ հաղորդագրությունը
            const uDiv = document.createElement('div');
            uDiv.className = 'msg user-msg';
            uDiv.innerText = text;
            container.appendChild(uDiv);
            input.value = '';
            
            // 2. Ավելացնում ենք Loading ցուցիչը
            isAiLoading = true;
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'typing';
            loadingDiv.id = 'ai-loading';
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();
                
                // Հեռացնում ենք Loading-ը
                document.getElementById('ai-loading').remove();

                // 3. Ավելացնում ենք AI-ի պատասխանը
                const aiDiv = document.createElement('div');
                aiDiv.className = 'msg ai-msg';
                aiDiv.innerText = data.text || "Կներեք, սխալ տեղի ունեցավ:";
                container.appendChild(aiDiv);
                
            } catch(e) {
                if(document.getElementById('ai-loading')) document.getElementById('ai-loading').remove();
                const errDiv = document.createElement('div');
                errDiv.className = 'msg ai-msg';
                errDiv.innerText = "Կապի սխալ: Փորձեք մի փոքր ուշ:";
                container.appendChild(errDiv);
            } finally {
                isAiLoading = false;
                container.scrollTop = container.scrollHeight;
            }
        }
    </script>
</body>
</html>